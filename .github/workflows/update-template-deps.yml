name: Update Template Dependencies

on:
  push:
    paths:
      - 'packages/curd/package.json'
      - 'packages/layout-antdv/package.json' 
      - 'packages/request/package.json'
      - 'packages/shared-config/package.json'
    branches:
      - main

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    if: github.repository == 'uozi-tech/admin-kit'
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Update Template Dependencies
        run: |
          # 获取各个包的最新版本
          CURD_VERSION=$(node -p "require('./packages/curd/package.json').version")
          LAYOUT_VERSION=$(node -p "require('./packages/layout-antdv/package.json').version")
          REQUEST_VERSION=$(node -p "require('./packages/request/package.json').version")
          SHARED_CONFIG_VERSION=$(node -p "require('./packages/shared-config/package.json').version")
          
          # 导出版本变量供后续步骤使用
          echo "CURD_VERSION=$CURD_VERSION" >> $GITHUB_ENV
          echo "LAYOUT_VERSION=$LAYOUT_VERSION" >> $GITHUB_ENV
          echo "REQUEST_VERSION=$REQUEST_VERSION" >> $GITHUB_ENV
          echo "SHARED_CONFIG_VERSION=$SHARED_CONFIG_VERSION" >> $GITHUB_ENV
          
          # 更新模板的 package.json
          cd packages/create-uozi-admin/template
          
          # 使用 jq 更新依赖版本
          jq --arg cv "$CURD_VERSION" \
             --arg lv "$LAYOUT_VERSION" \
             --arg rv "$REQUEST_VERSION" \
             --arg sv "$SHARED_CONFIG_VERSION" \
             '.dependencies["@uozi-admin/curd"] = "^" + $cv |
              .dependencies["@uozi-admin/layout-antdv"] = "^" + $lv |
              .dependencies["@uozi-admin/request"] = "^" + $rv |
              .devDependencies["@uozi-admin/shared-config"] = "^" + $sv' \
             package.json > package.json.tmp
          mv package.json.tmp package.json

      - name: Create Changeset
        run: |
          # 创建.changeset目录
          mkdir -p .changeset
          
          # 生成随机ID
          CHANGE_ID=$(date +%s%N | md5sum | head -c 8)
          
          # 创建changeset文件
          cat << EOF > .changeset/$CHANGE_ID.md
          ---
          "create-uozi-admin": patch
          ---
          
          Update template dependencies:
          - @uozi-admin/curd@^${CURD_VERSION}
          - @uozi-admin/layout-antdv@^${LAYOUT_VERSION}
          - @uozi-admin/request@^${REQUEST_VERSION}
          - @uozi-admin/shared-config@^${SHARED_CONFIG_VERSION}
          EOF

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: 'chore(create-uozi-admin): update template dependencies'
          title: 'chore(create-uozi-admin): update template dependencies'
          body: |
            Auto update template project dependencies version:
            
            - @uozi-admin/curd: ^${{ env.CURD_VERSION }}
            - @uozi-admin/layout-antdv: ^${{ env.LAYOUT_VERSION }}
            - @uozi-admin/request: ^${{ env.REQUEST_VERSION }}
            - @uozi-admin/shared-config: ^${{ env.SHARED_CONFIG_VERSION }}
          branch: update-template-deps
          base: main
          delete-branch: true 